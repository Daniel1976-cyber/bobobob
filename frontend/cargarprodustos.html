<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Administraci√≥n - Bazar El Romero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Configuraci√≥n de ambiente -->
  <script src="config.js"></script>

  <script>
    console.log("üöÄ [Admin] Iniciando carga de l√≥gica...");

    // Variables globales
    let catalogo = [];
    let ghSha = null;

    // Ayudantes de Configuraci√≥n
    const getConfig = () => window.API_CONFIG || {};

    // Ayudantes de Autenticaci√≥n
    window.getToken = () => sessionStorage.getItem('romeroToken') || localStorage.getItem('romeroToken');
    window.setToken = (t, persist) => {
      if (t) {
        if (persist) localStorage.setItem('romeroToken', t);
        else sessionStorage.setItem('romeroToken', t);
      } else {
        localStorage.removeItem('romeroToken');
        sessionStorage.removeItem('romeroToken');
      }
    };

    window.updateAuthUI = () => {
      const token = window.getToken();
      const isAuth = !!token || window.IS_LOCAL;

      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');
      const adminPanel = document.getElementById('adminPanel');
      const authStatus = document.getElementById('authStatus');

      if (loginScreen) loginScreen.style.display = isAuth ? 'none' : 'flex';
      if (mainContent) mainContent.style.display = isAuth ? 'block' : 'none';
      if (adminPanel) adminPanel.style.display = isAuth ? 'block' : 'none';
      if (authStatus) authStatus.textContent = isAuth ? 'Autenticado ‚úì' : 'No autenticado';

      console.log("UI Actualizada. Autenticado:", isAuth);
    };

    window.login = async () => {
      const token = document.getElementById('password').value.trim();
      if (!token) return alert('Por favor ingresa tu Token de GitHub');

      try {
        const config = getConfig();
        const res = await fetch(`${config.API_URL}/repos/${config.REPO_OWNER}/${config.REPO_NAME}`, {
          headers: { 'Authorization': `token ${token}` }
        });

        if (!res.ok) throw new Error('Token inv√°lido o sin permisos');

        const persist = document.getElementById('rememberMe').checked;
        window.setToken(token, persist);
        window.updateAuthUI();
        alert('‚úì Conexi√≥n exitosa');
        await window.fetchProducts();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.logout = () => {
      if (confirm('¬øCerrar sesi√≥n?')) {
        window.setToken(null);
        window.updateAuthUI();
      }
    };

    window.fetchProducts = async () => {
      try {
        const config = getConfig();
        if (window.IS_LOCAL) {
          const res = await fetch('data/catalog.json');
          catalogo = await res.json();
        } else {
          const token = window.getToken();
          const headers = token ? { 'Authorization': `token ${token}` } : {};
          const res = await fetch(`${config.API_URL}/repos/${config.REPO_OWNER}/${config.REPO_NAME}/contents/${config.FILE_PATH}`, { headers });
          if (!res.ok) throw new Error('No se pudo cargar catalog.json');
          const data = await res.json();
          ghSha = data.sha;
          const content = decodeURIComponent(escape(atob(data.content.replace(/\s/g, ''))));
          catalogo = JSON.parse(content);
        }
        window.mostrarTabla();
      } catch (e) {
        console.error(e);
        alert('Error al cargar productos: ' + e.message);
      }
    };

    window.mostrarTabla = () => {
      const tbody = document.getElementById('listaProd');
      if (!tbody) return;
      tbody.innerHTML = '';
      catalogo.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nombre}</td>
          <td>${p.precio}</td>
          <td>
            <button class="inline" onclick="window.deleteProduct(${p.id})">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    };

    window.deleteProduct = async (id) => {
      if (!confirm('¬øBorrar?')) return;
      catalogo = catalogo.filter(p => p.id !== id);
      await window.saveToGitHub();
      window.mostrarTabla();
    };

    window.saveToGitHub = async () => {
      if (window.IS_LOCAL) return alert('Modo Local: Cambios no guardados en GitHub');
      const config = getConfig();
      const token = window.getToken();
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(catalogo, null, 2))));

      try {
        const res = await fetch(`${config.API_URL}/repos/${config.REPO_OWNER}/${config.REPO_NAME}/contents/${config.FILE_PATH}`, {
          method: 'PUT',
          headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Update catalog', content, sha: ghSha })
        });
        if (!res.ok) throw new Error('Error al sincronizar con GitHub');
        const data = await res.json();
        ghSha = data.content.sha;
        alert('‚úì GitHub actualizado');
      } catch (e) {
        alert('Error: ' + e.message);
      }
    };

    window.addEventListener('DOMContentLoaded', () => {
      console.log("DOM Cargado. Verificando auth...");
      window.updateAuthUI();
      if (window.getToken() || window.IS_LOCAL) window.fetchProducts();
    });
  </script>

  <style>
    :root {
      --verde: #3a6b4a;
      --crema: #f5f1e8;
      --tierra: #8c5e46;
      --texto: #2e2e2e;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 1.5rem;
      background: var(--crema);
      color: var(--texto);
    }

    h2,
    h3 {
      color: var(--verde);
      margin-bottom: 1rem;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 0.7rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      border: 1px solid var(--tierra);
    }

    button {
      background-color: var(--verde);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }

    button.inline {
      padding: 0.3rem 0.6rem;
      width: auto;
    }

    .auth-section {
      border: 2px solid var(--verde);
      padding: 1.2rem;
      border-radius: 8px;
      background: white;
      margin-bottom: 1.5rem;
      max-width: 400px;
      margin: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-top: 1rem;
    }

    th,
    td {
      padding: 0.8rem;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: var(--verde);
      color: white;
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginScreen"
    style="display: flex; align-items: center; justify-content: center; position: fixed; inset: 0; background: var(--crema); z-index: 1000; flex-direction: column;">
    <div class="auth-section">
      <h2 style="text-align: center;">Bazar El Romero</h2>
      <div id="authStatus" style="text-align: center; font-weight: bold; margin-bottom: 1rem;">No autenticado</div>
      <input id="password" type="password" placeholder="Ingresa tu Token de GitHub" />
      <div style="font-size: 0.9rem; margin-bottom: 1rem;">
        <input type="checkbox" id="rememberMe"> Recordarme
      </div>
      <button onclick="window.login()">Conectar con GitHub</button>
    </div>
  </div>

  <!-- PANEL -->
  <div id="mainContent" style="display: none; max-width: 1000px; margin: auto;">
    <h2>Panel Administrativo</h2>
    <div id="adminPanel">
      <button onclick="document.getElementById('excelFile').click()">üì• Importar Excel</button>
      <input type="file" id="excelFile" style="display: none;" onchange="window.cargarExcel(event)" />

      <div style="margin-top: 2rem;">
        <h3>Cat√°logo Actual</h3>
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="listaProd"></tbody>
        </table>
      </div>

      <button onclick="window.logout()" style="margin-top: 2rem; background-color: #8c5e46;">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <script>
    // L√≥gica para Excel (debe ir despu√©s del input)
    window.cargarExcel = (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = async (e) => {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        const newProds = rows.map(r => ({
          id: Date.now() + Math.random(),
          nombre: r.Nombre || r.nombre,
          precio: r.Precio || r.precio,
          active: true
        }));
        catalogo = [...catalogo, ...newProds];
        await window.saveToGitHub();
        window.mostrarTabla();
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>

</html>